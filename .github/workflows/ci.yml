name: Zero Trust CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-tests:
    name: Security & Compliance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up test environment
      run: |
        sudo apt-get update
        sudo apt-get install -y openssl iproute2 iptables
        
    - name: Run comprehensive test suite
      run: |
        chmod +x test-suite.sh
        ./test-suite.sh
        
    - name: Validate shell scripts
      run: |
        for script in *.sh; do
          echo "Checking $script..."
          bash -n "$script"
        done
        
    - name: Check certificate security
      run: |
        # Verify all certificates are valid
        openssl verify -CAfile certs/ca-cert.pem certs/server-cert.pem
        openssl verify -CAfile certs/ca-cert.pem certs/client-cert.pem
        
        # Check key strengths
        for cert in certs/*.pem; do
          if [[ "$cert" == *"cert.pem" ]] && [[ "$cert" != *"key.pem" ]]; then
            echo "Checking $cert..."
            openssl x509 -in "$cert" -noout -text | grep "Public-Key:"
          fi
        done
        
    - name: Scan for vulnerabilities
      run: |
        # Check for common security issues
        echo "Scanning for hardcoded credentials..."
        ! grep -riE "password|secret|api_key" *.sh | grep -v "^#" | grep -v "TEST" | grep -v "echo"
        
        echo "Checking file permissions..."
        ls -la certs/*.pem
        
    - name: Generate test report
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All security tests completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Certificate Status" >> $GITHUB_STEP_SUMMARY
        openssl x509 -in certs/ca-cert.pem -noout -enddate >> $GITHUB_STEP_SUMMARY

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        severity: warning
        
  documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README exists
      run: |
        test -f README.md
        echo "✅ README.md found"
        
    - name: Validate markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        
  compliance-check:
    name: Compliance & Best Practices
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Zero Trust principles
      run: |
        echo "Validating Zero Trust implementation..."
        
        # Verify policy enforcement exists
        test -f zero-trust-policy.sh
        echo "✅ Policy enforcement engine found"
        
        # Verify mTLS infrastructure
        test -f certs/ca-cert.pem
        test -f certs/server-cert.pem
        test -f certs/client-cert.pem
        echo "✅ Mutual TLS certificates found"
        
        # Verify monitoring
        test -f security-monitoring.sh
        test -f automated-monitoring.sh
        echo "✅ Security monitoring found"
        
        # Verify network segmentation
        test -f network-namespace-demo.sh
        echo "✅ Network segmentation demo found"
        
        echo "All Zero Trust components validated ✓"
